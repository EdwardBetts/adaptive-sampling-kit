#!/usr/bin/env Rscript


suppressPackageStartupMessages(require(gbm, quietly=T))

args <- commandArgs(trailingOnly = T)

if (length(args) != 3) {
    stop("Usage: gbm_build <configuration.conf> <labelled_file> <output_file>")
}

source(file.path(Sys.getenv("ASKHOME"), "common/configuration.R"))
input = read.table(args[2])


# Set up categorical variables as factors
i = 1
for (f in conf("factors")) {
  if (f$type == "categorical") {
    input[,i] = as.factor(input[,i])
  }
  i = i+1
}

expr = eval(parse(text=paste("input$V",ncol(input),"~ .",sep="")))
gbm1 = gbm(expr ,
           data=input,
           n.trees=conf("modules.model.params.ntrees",3000),
           interaction.depth=conf("modules.model.params.interactiondepth", 8),
           shrinkage=conf("modules.model.params.shrinkage", 0.01),
           distribution=conf("modules.model.params.distribution","gaussian"),
           verbose=conf("modules.model.params.verbose", F))
best.iter = gbm.perf(gbm1,plot.it=FALSE, method="OOB")

save(gbm1,best.iter,file=args[3])

