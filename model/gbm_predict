#!/usr/bin/env Rscript

suppressPackageStartupMessages(require(gbm, quietly=T))
require(rjson, quietly=T)

args <- commandArgs(trailingOnly = T)

if (length(args) != 4) {
    stop("Usage: gbm <configuration.conf> <model> <requested_file> <output_file>")
}

# Load the previous model
req = read.table(args[3])

# Set up categorical variables as factors
configuration = fromJSON(paste(readLines(args[1]), collapse=""))
i = 1
for (f in configuration$factors) {
  if (f$type == "categorical") {
    req[,i] = as.factor(req[,i])
  } 
  i = i+1
}

output = args[4]
# Load gbm model
load(args[2])

requested = eval(parse(text=paste("cbind(req[,1:ncol(input)-1], V",
                 ncol(input),"=rep(0, nrow(req)))", sep="")))

pred = predict(gbm1, requested, n.trees=best.iter)
out_data = cbind(requested[,1:ncol(input)-1], pred)
write.table(out_data, file=output, row.names=F, col.names=F)
