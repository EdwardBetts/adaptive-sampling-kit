#!/usr/bin/env Rscript

suppressPackageStartupMessages(require(gbm, quietly=T))
args <- commandArgs(trailingOnly = T)

if (length(args) != 4) {
    stop("Usage: gbm_predict <configuration.conf> <model> <requested_file> <output_file>")
}

source(file.path(Sys.getenv("ASKHOME"), "common/configuration.R"))
# read the requested points
req = read.table(args[3])

# Set up categorical variables as factors
i = 0
for (f in conf("factors")) {
  i = i+1
  if (f$type == "categorical") {
    req[,i] = as.factor(req[,i])
  }
}
nfactors=i

output = args[4]
# Load gbm model (gbm1, best.iter)
load(args[2])


requested = eval(parse(text=paste("cbind(req[,1:nfactors], V",
                 nfactors+1,"=rep(0, nrow(req)))", sep="")))

pred = predict(gbm1, requested, n.trees=best.iter)
out_data = cbind(requested[,1:nfactors], pred)
write.table(out_data, file=output, row.names=F, col.names=F)
